<html>
<head>
<script src='tweeeeeeeeeetParser.js'></script>
<script src='tweeeeeeeeeetInterpreter.js'></script>
<script src='localstorage.js'></script>
<script src='simplerestclient.js'></script>


<script type="text/javascript">
	"use strict";
	
	function getNodeText(node) {
		if(typeof node.innerText !== 'undefined'){
			return node.innerText;
		}else{
			return  node.textContent;
		}	
	}
	
	function setNodeText(node, text) {
		if(typeof node.innerText !== 'undefined'){
			node.innerText = text;
		}else{
			node.textContent = text;
		}	
	}
	
	function escapeQuotationMarkCharacters(text) {
		return text.replace(/'/g, "''");
	}

	function showResultLength() {
		var result = getNodeText(document.getElementById('result'));
		var tweetSize = tweeeeeeeeeet.createTweetSizeObject(result);
		var resultWithSortenedLinksLength = tweetSize.lengthWithShortenedUrls();
		setNodeText(document.getElementById('resultLength'), resultWithSortenedLinksLength);
		
		var resultLength = result.length;
		setNodeText(document.getElementById('shortenedLink'), '');
		if (resultLength !== resultWithSortenedLinksLength) {
			setNodeText(document.getElementById('shortenedLink'), '(Links will be shortened)');
		}
	}

	function shorten() {
	
		showLength();
		
		setNodeText(document.getElementById('errorMessage'), '');
		var program = "shortenTweet: '" + escapeQuotationMarkCharacters(document.getElementById('yourTweet').value) + "' " +  document.getElementById('tweeeeeeeeeetProgram').value;
		var parseResult = '';
		try{
			 parseResult = parser.parse(program);
		}
		catch(e) {
			setNodeText(document.getElementById('errorMessage'), e.name + ' Error: (' + e.line + ',' + e.column + ') ' + e.message);
			return;
		}
		finally {		
			setNodeText(document.getElementById('result'), parseResult);
			
			if (parseResult === '') { parseResult = ' '; } 		
			parseResult = escape(parseResult);
			document.getElementById('copyClipboard').innerHTML = '<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="110" height="14" id="clippy" > <param name="movie" value="lib/clippy.swf"/> <param name="allowScriptAccess" value="always" /> <param name="quality" value="high" /> <param name="scale" value="noscale" /> <param NAME="FlashVars" value="text=' + parseResult + '"> <param name="bgcolor" value="#FFFFFF"> <embed src="lib/clippy.swf" width="110" height="14" name="clippy" quality="high" allowScriptAccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" FlashVars="text=' + parseResult + '" bgcolor="#FFFFFF" />  <\/object>';
		}
		
		showResultLength();
	}

	function showLength() {
		setNodeText(document.getElementById('yourTweetLength'), document.getElementById('yourTweet').value.length);
	}

	function createTweeeeeeeeeetInstructionsObject(localStorage) {
		
		var _localStorage = localStorage;
		
		return {
			version: '0.6 (beta)',

			localStorageIsEmpty: function() {
				return !tweeeeeeeeeet.localStorage.hasOwnProperty('TweeeeeeeeeetInstructions_Version');
			},
			
			loadFromLocalStorage: function() {
				var instructions = '';

				if (tweeeeeeeeeet.localStorage.hasOwnProperty('TweeeeeeeeeetInstructions_Version') === false) {		
					return instructions;
				}

				var i = 0;
				while(tweeeeeeeeeet.localStorage.hasOwnProperty('TweeeeeeeeeetInstructions_Code_' + i.toString())) {
					instructions += tweeeeeeeeeet.localStorage.getItem('TweeeeeeeeeetInstructions_Code_' + i.toString());
					++i;
				}

				return instructions;
			},
			
			saveOnLocalStorage: function(instructions) {				
				var size = instructions.length;
				var blockSize = 1024;
				var blocks = Math.ceil(size / blockSize);
				
				var i;
				for(i = 0; i < blocks; ++i) {
					_localStorage.setItem('TweeeeeeeeeetInstructions_Code_' + i.toString(), instructions.substring(blockSize * i, blockSize * (i+1)));		
				}		
				_localStorage.removeItem('TweeeeeeeeeetInstructions_Code_' + blocks.toString());
				
				_localStorage.setItem('TweeeeeeeeeetInstructions_Version', version);				
			}						
		};
	}
	
	var tweeeeeeeeeetInstructions = createTweeeeeeeeeetInstructionsObject(tweeeeeeeeeet.localStorage);
		
	window.onload = function() {
		document.getElementById('shortenButton').onclick = shorten;
		document.getElementById('yourTweet').onchange = showLength;
		document.getElementById('tweeeeeeeeeetProgram').onchange = function() { 
			document.getElementById('saveButton').disabled = false; 
			document.getElementById('loadButton').disabled = tweeeeeeeeeetInstructions.localStorageIsEmpty();
		};
		document.getElementById('saveButton').onclick = function() { 
			shorten();
			if (getNodeText(document.getElementById('errorMessage')).length === 0) {
				document.getElementById('saveButton').disabled = true; 
				document.getElementById('loadButton').disabled = true;
				
				tweeeeeeeeeetInstructions.saveOnLocalStorage(document.getElementById('tweeeeeeeeeetProgram').value);
				var simpleRestClient = tweeeeeeeeeet.createSimpleRestClientObject();				
				simpleRestClient.post('http://www.luca.minudel.it/CollectModifiedTweeeeeeeeeetInstructions.aspx', 'text/plain', document.getElementById('tweeeeeeeeeetProgram').value);				
			} else {
				alert('Correct Syntax error before saving. ');
			}
		};
		document.getElementById('loadButton').onclick = function() { 
			document.getElementById('saveButton').disabled = true; 
			document.getElementById('loadButton').disabled = true;
			
			document.getElementById('tweeeeeeeeeetProgram').value = tweeeeeeeeeetInstructions.loadFromLocalStorage();
		};
		
		document.getElementById('loadButton').disabled = tweeeeeeeeeetInstructions.localStorageIsEmpty();
		
		window.onbeforeunload = function() { 
			document.getElementById('yourTweet').focus(); // force pending onchange events to update the 'changed' state
			if (!document.getElementById('saveButton').disabled) {
				return "Tweeeeeeeeeet instructions has been modified but not saved."; 
			} 
		};
	};	
</script>
<style type="text/css">
.menu{
	width: 100%; /* The menu should be the entire width of it's surrounding object, in this case the whole page */
	font:11px Arial, Helvetica, sans-serif; /* Sets the font size and type */
} 

.menu ul{
	margin: 0;
	padding: 0;
	top: 0;
	left: 0;
    width: 100%;	
    background-color: #2D2D2D;
    background-image: none;
    background-position: 0 -138px;
    background-repeat: repeat-x;
    border-bottom: 1px solid #000000;
    opacity: 1;
    position: absolute;
}

.menu ul li{
    margin: 0;
    padding: 0;
	display: inline;} /* Makes the link all appear in one line, rather than on top of each other */

.menu ul li a{
	float: left; 
	text-decoration: none; /* removes the underline from the menu text */
	color: #fff; /* text color of the menu */
	padding: 10.5px 11px; /* 10.5px of padding to the right and left of the link and 11px to the top and bottom */
}

.menu ul li a:visited{ /* This bit just makes sure the text color doesn't change once you've visited a link */
	color: #fff;
	text-decoration: none;}

</style>

<title>tweeeeeeeeeet 0.6 (beta)</title>
</head>
<body>
<form>
	<div class="menu">
		<ul>
			<li><a href="#SendFeedback">Send Feedback</a></li>
			<li><a href="https://github.com/lucaminudel/tweeeeeeeeeet/downloads" target="_blank">Download the latest version</a></li>
			<li><a href="spec/SpecRunner.html" target="_blank">Run tests</a></li>
		</ul>
	<br style="clear:left"/>
	</div>
	<h1>Your tweeeeeeeeeet</h1>
	<textarea id='yourTweet' rows='4' cols='80'></textarea>
	<br />
	<button type='button' id='shortenButton'>Shorten your tweet</button>   <label>Length: </label><span id='yourTweetLength' >0</span>
	<br />
	<br />
	
	<h1>Your tweet shortened</h1>
	<textarea id='result' readonly=true rows='4' cols='80' style='background-color:#d0e4fe;'>Your tweet shortened here.</textarea>
	<br />
	<label>Length: </label><span id='resultLength' >0</span> <span id='shortenedLink' ></span>  
	<span id='copyClipboard'>
	</span>
	<br />
	<br />

	<h1>Tweeeeeeeeeet instructions to shorten your tweeeeeeeeeet</h1>
    <span id='errorMessage' style='color:red;'></span>
	<br />
	<button type='button' id='loadButton' disabled='true'>Load</button>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<button type='button' id='saveButton' disabled='true'>Save</button>
	<br />
	<textarea id='tweeeeeeeeeetProgram'  cols='60' rows='128'>replaceUntilFitsInto: 140
withAbbreviations:
(
  substring: '  ' -> ' '
  'with' -> 'w/'
  'and' -> '&'
  'without' -> 'w/o'
  'someone' -> 'some1'
  'some1' -> 's/o'
  'something' -> 's/t'
  'before' -> 'b4'
  'because' -> 'b/c'
  'by the way' -> 'BDW'
  'between' -> 'b/w'
  'one' -> '1'
  'once' -> '1NC'
  'two' -> '2'
  'three' -> '3'
  'four' -> '4'
  'ten' -> '10'
  'tens' -> '10s'
  'hundred' -> '100'
  'hundreds' -> '100s'
  'thousand' -> '1000'
  'thousands' -> '1000'
  'for example' -> 'e.g.'
  'do not' -> 'don''t'
  'does not' -> 'doesn''t'
  'did not' -> 'did''t'
  'I am' -> 'I''m'
  'it is' -> 'it''s'
  'he is' -> 'he''s'
  'she is' -> 'she''s'
  'we are' -> 'we''re'
  'they are' -> 'they''re'
  'you are' -> 'you''re'  
  'information' -> 'info'
  'as far as I know' -> 'AFAIK'
  'as far as I understand' -> 'AFAIU'
  'as far as I understood' -> 'AFAIU'
  'today' -> '2day'
  'tonight' -> '2night'
  'tomorrow' -> '2morrow'
  'together' -> '2gether'
  'for ever' -> '4ever'
  'afford' -> 'a4rd'
  'you''re' -> 'UR'
  'for you' -> '4U'
  'see you' -> 'CU'
  'you' -> 'U'
  'are' -> 'R'
  'why' -> 'Y'
  'key' -> 'K'
  'versus' -> 'Vs'
  'busy' -> 'BZ'
  'easy' -> 'EZ'
  'number' -> '#'
  'people' -> 'ppl'
  'be' -> 'B'
  'to B' -> '2B'
  'too late' -> '2L8'
  'late' -> 'L8'
  'later' -> 'L8r'
  'matter' -> 'M8r'
  'great' -> 'gr8'
  'wait' -> 'w8'
  'waiting' -> 'w8N'
  'hate' -> '8'
  'greater than' -> '>'
  'less than' -> '<'
  'thanks' -> '10X'
  'thank you' -> '10U'
  'threesome ' -> '3SUM'
  'I see' -> 'IC'
  'excellent' -> 'XLNT'
  'excel' -> 'XL'
  'at work' -> '@WRK'
  'work' -> 'WRK'
  'at' -> '@'
  'don''t' -> 'DNT'  
  'effective' -> 'Fective'
  'for' -> '4'
  'to' -> '2'
  'too' -> '2'
  'the' -> 'D'
  'their' -> 'Dr'
  'that' -> 'Dt'
  'this' -> 'Ds'
  'than' -> 'Dn'
  'then' -> 'Dn'  
  'your' -> 'Ur'
  'from' -> 'frm'
  'increase' -> 'incr.'
  'increases' -> 'incr.'
  'decrease' -> 'decr.'
  'decreases' -> 'decr.'
  'development' -> 'dev.mnt'
  'dev.mnt' ->  'dev'
  'system' -> 'sys'
  'see' -> 'C'
  substring: ' ,' -> ','
  substring: ', ' -> ','
  substring: ' .' -> '.'
  substring: ' :' -> ':'
  substring: ': ' -> ':'
  substring: ' ;' -> ';'
  substring: '; ' -> ';'
  substring: 'too' -> '2'
  substring: 'to' -> '2'
  substring: 'hate' -> '8'
  substring: 'eat' -> '8'
  substring: 'ait' -> '8'
  substring: 'two' -> '2'
  substring: 'tree' -> '3'
  substring: 'ttre' -> '3'
  substring: 'tre' -> '3'
  substring: 'four' -> '4'
  substring: 'for' -> '4'
  substring: 'see' -> 'C'
  substring: ' "' -> '"'
  substring: '" ' -> '"'
  substring: ' (' -> '('
  substring: '( ' -> '('
  substring: ' )' -> ')'
  substring: ') ' -> ')'
  substring: '& ' -> '&'
  substring: ' &' -> '&'
 )</textarea>
 </form>
<h1><a name="SendFeedback">Send Feedback</a></h1>
<p>
	To share your improvements to the <dfn>Tweeeeeeeeeet instructions</dfn>, to suggest new features, to report bugs and to contribute with code.<br />
	You can send your feedback <a href='https://github.com/lucaminudel/tweeeeeeeeeet/issues' target="_blank">here on github</a> and  <a href='https://twitter.com/lukadotnet' target="_blank">here on twitter</a>.
</p>
</body>
</html> 